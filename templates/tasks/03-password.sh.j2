# --- TASK: 03-PASSWORD ---
log ".. task: 03-password (syncing system credentials)"

{% if node.vault_users is defined %}
{% for username, data in node.vault_users.items() %}
# Procesando usuario: {{ username }}
if id "{{ username }}" &>/dev/null; then
    log ".... setting password hash for user: {{ username }}"
    # Usamos -e para indicar que lo que enviamos es un hash (encrypted)
    # Esto es idempotente: si el hash es el mismo, el sistema no sufre cambios notables
    echo '{{ username }}:{{ data.password }}' | chpasswd -e

    if [ $? -eq 0 ]; then
        log ".... user {{ username }} updated successfully"
    else
        log ".... ERROR: failed to update password for {{ username }}"
    fi
else
    log ".... skipping {{ username }}: user does not exist on this system"
fi
{% endfor %}
{% else %}
log ".... warning: no vault_users defined in inventory/vault.yml"
{% endif %}
